<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>Insideout.bond</title>
    <link rel="shortcut icon" href="images/logo.png" type="image/x-icon">
    <meta name="application-name" content="Insideout.bond">

    <!-- Meta Tags for SEO -->
    <meta name="description"
        content="Merge multiple PDF documents into a single high-quality file instantly. Safe, private, and works entirely in your browser. All processing happens locally for maximum privacy.">
    <meta name="keywords"
        content="pdf merger, combine pdf, merge pdf files, secure pdf tools, browser-based tools, Insideout.bond">
    <link rel="canonical" href="https://insideout.bond/Tools/pdf-merger.html">

    <!-- AdSense -->
    <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2280832801216201"
        crossorigin="anonymous"></script> -->

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1605V9LS1K"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-1605V9LS1K');
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- pdf-lib for PDF manipulation -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <!-- SortableJS for drag and drop reordering -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .drag-over {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            transform: scale(1.01);
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: #dbeafe;
        }

        /* Prevent child elements from triggering dragleave events */
        #dropZone * {
            pointer-events: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div class="max-w-4xl mx-auto px-4 py-12">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-slate-800 mb-2">PDF Merger Pro</h1>
            <p class="text-slate-600">High-fidelity merging. Secure, private, and zero quality loss.</p>
        </header>

        <!-- Main Card -->
        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">

            <!-- Drop Zone -->
            <div id="dropZone"
                class="m-6 p-10 border-2 border-dashed border-slate-300 rounded-xl transition-all duration-200 flex flex-col items-center justify-center group cursor-pointer hover:border-blue-400 hover:bg-blue-50">
                <input type="file" id="fileInput" multiple accept=".pdf" class="hidden">
                <div class="bg-blue-100 p-4 rounded-full text-blue-600 mb-4 group-hover:scale-110 transition-transform">
                    <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-700">Click to upload or drag and drop</h3>
                <p class="text-sm text-slate-500 mt-1">Upload multiple PDF files</p>
            </div>

            <!-- File List Section -->
            <div id="fileListContainer" class="hidden border-t border-slate-100">
                <div class="px-6 py-4 flex justify-between items-center bg-slate-50">
                    <h2 class="font-bold text-slate-700 flex items-center gap-2">
                        <i data-lucide="list" class="w-4 h-4"></i>
                        Files to Merge (<span id="fileCount">0</span>)
                    </h2>
                    <button id="clearAllBtn"
                        class="text-xs font-semibold text-red-500 hover:text-red-700 transition-colors uppercase tracking-wider">
                        Clear All
                    </button>
                </div>

                <div id="fileList" class="max-h-[400px] overflow-y-auto px-6 py-2 custom-scrollbar">
                    <!-- Files will be injected here -->
                </div>

                <!-- Footer Actions -->
                <div
                    class="p-6 bg-white border-t border-slate-100 flex flex-col sm:flex-row gap-4 items-center justify-between">
                    <div class="text-sm text-slate-500 italic">
                        <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                        Use the grip icon <i data-lucide="grip-vertical" class="w-3 h-3 inline"></i> to reorder.
                    </div>
                    <button id="mergeBtn"
                        class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="combine" class="w-5 h-5"></i>
                        Merge & Download
                    </button>
                </div>
            </div>
        </div>

        <!-- Notification/Message Box -->
        <div id="messageBox"
            class="fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl transition-all duration-300 opacity-0 pointer-events-none flex items-center gap-3">
            <span id="messageText"></span>
        </div>

        <!-- Processing Overlay -->
        <div id="loader"
            class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden flex-col items-center justify-center z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white mb-4"></div>
            <p id="loaderText" class="text-white font-bold text-lg">Initializing...</p>
        </div>
    </div>

    <script>
        const { PDFDocument } = PDFLib;

        // State
        let uploadedFiles = [];

        // Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileCountSpan = document.getElementById('fileCount');
        const mergeBtn = document.getElementById('mergeBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        // Initialize Lucide icons
        lucide.createIcons();

        // Initialize Sortable with specific handle to prevent accidental drags
        const sortable = new Sortable(fileList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            handle: '.drag-handle', // Bug fix: Only drag when holding the handle
            onEnd: () => {
                // Update internal file array order based on DOM order
                const newOrder = Array.from(fileList.children).map(child => child.dataset.id);
                const reorderedFiles = newOrder.map(id => uploadedFiles.find(f => f.id === id)).filter(Boolean); // filter(Boolean) for safety
                uploadedFiles = reorderedFiles;
            }
        });

        // Event Listeners
        dropZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            handleFiles(Array.from(e.target.files));
            fileInput.value = '';
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        // Simplified logic thanks to pointer-events: none in CSS
        dropZone.addEventListener('dragleave', (e) => {
            // Check if we are really leaving the dropzone, not just entering a child
            if (e.relatedTarget && !dropZone.contains(e.relatedTarget)) {
                dropZone.classList.remove('drag-over');
            }
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
            if (files.length > 0) handleFiles(files);
            else if (e.dataTransfer.files.length > 0) showMessage('Only PDF files are supported', 'error');
        });

        clearAllBtn.addEventListener('click', () => {
            uploadedFiles = [];
            renderFileList();
            showMessage('All files removed', 'info');
        });

        // Event Delegation for Delete Button (More efficient than global functions)
        fileList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                removeFile(id);
            }
        });

        mergeBtn.addEventListener('click', mergePDFs);

        // Functions
        function handleFiles(files) {
            let addedCount = 0;
            files.forEach(file => {
                // Bug fix: ignore 0-byte files
                if (file.size === 0) {
                    console.warn(`Skipped empty file: ${file.name}`);
                    return;
                }
                const fileObj = {
                    id: crypto.randomUUID(),
                    name: file.name,
                    size: formatFileSize(file.size),
                    data: file
                };
                uploadedFiles.push(fileObj);
                addedCount++;
            });

            if (addedCount > 0) {
                renderFileList();
                showMessage(`${addedCount} file(s) added`, 'success');
            } else if (files.length > 0) {
                showMessage('No valid files added', 'error');
            }
        }

        function removeFile(id) {
            uploadedFiles = uploadedFiles.filter(f => f.id !== id);
            renderFileList();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function renderFileList() {
            if (uploadedFiles.length === 0) {
                fileListContainer.classList.add('hidden');
                return;
            }

            fileListContainer.classList.remove('hidden');
            fileCountSpan.textContent = uploadedFiles.length;
            fileList.innerHTML = '';

            uploadedFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-4 mb-2 bg-white border border-slate-200 rounded-lg hover:shadow-md transition-shadow select-none';
                item.dataset.id = file.id;

                // Security Fix: Construct DOM manually to prevent XSS in filenames
                const leftDiv = document.createElement('div');
                leftDiv.className = 'flex items-center gap-3 overflow-hidden';

                const handleDiv = document.createElement('div');
                handleDiv.className = 'drag-handle cursor-grab active:cursor-grabbing p-2 hover:bg-slate-100 rounded text-slate-400';
                handleDiv.innerHTML = '<i data-lucide="grip-vertical" class="w-4 h-4"></i>';

                const iconDiv = document.createElement('div');
                iconDiv.className = 'bg-red-50 p-2 rounded text-red-500 shrink-0';
                iconDiv.innerHTML = '<i data-lucide="file-text" class="w-5 h-5"></i>';

                const infoDiv = document.createElement('div');
                infoDiv.className = 'overflow-hidden';

                const nameP = document.createElement('p');
                nameP.className = 'text-sm font-medium text-slate-800 truncate max-w-[150px] sm:max-w-xs';
                nameP.textContent = file.name; // Secure text content

                const sizeP = document.createElement('p');
                sizeP.className = 'text-xs text-slate-500';
                sizeP.textContent = file.size;

                infoDiv.appendChild(nameP);
                infoDiv.appendChild(sizeP);
                leftDiv.appendChild(handleDiv);
                leftDiv.appendChild(iconDiv);
                leftDiv.appendChild(infoDiv);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn p-2 text-slate-400 hover:text-red-500 transition-colors rounded-full hover:bg-red-50 shrink-0';
                deleteBtn.dataset.id = file.id;
                deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';

                item.appendChild(leftDiv);
                item.appendChild(deleteBtn);
                fileList.appendChild(item);
            });
            lucide.createIcons();

            mergeBtn.disabled = uploadedFiles.length < 2;
        }

        async function mergePDFs() {
            if (uploadedFiles.length < 2) return;

            loaderText.textContent = "Initializing...";
            loader.classList.remove('hidden');
            loader.classList.add('flex');

            try {
                // Bug fix: Let the UI render the loader before blocking execution
                await new Promise(r => setTimeout(r, 50));

                const mergedPdf = await PDFDocument.create();
                let processedCount = 0;

                for (const fileObj of uploadedFiles) {
                    processedCount++;
                    loaderText.textContent = `Processing file ${processedCount} of ${uploadedFiles.length}...`;

                    // Allow UI to update between heavy operations
                    await new Promise(r => requestAnimationFrame(r));

                    const arrayBuffer = await fileObj.data.arrayBuffer();

                    let pdf;
                    try {
                        pdf = await PDFDocument.load(arrayBuffer);
                    } catch (e) {
                        throw new Error(`Failed to load "${fileObj.name}". The file may be encrypted or corrupted.`);
                    }

                    const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    copiedPages.forEach((page) => mergedPdf.addPage(page));
                }

                loaderText.textContent = "Finalizing document...";
                await new Promise(r => requestAnimationFrame(r));

                const mergedPdfBytes = await mergedPdf.save();

                const timestamp = new Date().toISOString().slice(0, 10);
                download(mergedPdfBytes, `merged_doc_${timestamp}.pdf`, "application/pdf");

                showMessage('PDFs merged successfully!', 'success');
            } catch (error) {
                console.error(error);
                showMessage(error.message || 'Error merging PDFs.', 'error');
            } finally {
                loader.classList.add('hidden');
                loader.classList.remove('flex');
            }
        }

        function download(data, filename, type) {
            const file = new Blob([data], { type: type });
            const a = document.createElement("a");
            const url = URL.createObjectURL(file);
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }

        function showMessage(text, type) {
            messageText.textContent = text;

            messageBox.className = 'fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl transition-all duration-300 flex items-center gap-3 z-[60]';

            if (type === 'success') {
                messageBox.classList.add('bg-emerald-600', 'text-white');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-600', 'text-white');
            } else {
                messageBox.classList.add('bg-slate-800', 'text-white');
            }

            messageBox.style.opacity = '1';
            messageBox.style.transform = 'translate(-50%, -20px)';
            messageBox.style.pointerEvents = 'auto';

            setTimeout(() => {
                messageBox.style.opacity = '0';
                messageBox.style.transform = 'translate(-50%, 0)';
                messageBox.style.pointerEvents = 'none';
            }, 4000);
        }
    </script>
</body>

</html>